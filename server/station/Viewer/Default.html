<!DOCTYPE html>
<html>
<head>
    <title>Solar Station Date Viewer</title>
	<link rel="stylesheet" href="./Content/bootstrap.min.css" />
	<link rel="stylesheet" href="./Content/bootstrap-reboot.min.css" />
	<link rel="stylesheet" href="./Content/bootstrap-datepicker3.min.css" />
    <style type="text/css">
		canvas {
			-moz-user-select: none;
			-webkit-user-select: none;
			-ms-user-select: none;
		}

        .container2 {
            background-color: #CCCCCC;
            border: thick solid #000000;
            padding: 5px;
            margin: 0px;
        }

		.section {
			opacity: 0.75;
			padding: 5px;
		}
		.section h1 {
			color: black;
			font-size: 20px;
			font-weight: bolder;
			margin-left: 0px;
			margin-right: 0px;
			margin-top: 5px;
			margin-bottom: 5px;
			padding: 0px;
		}
    </style>
</head>
<body>
    <div class="container-fluid container2" ng-app="mainApp" ng-controller="mainController">
		<!-- Graphs -->
		<div class="section">
			<h1>Graphs</h1>
			<div class="alert alert-success" role="alert">
				Attention, la récupération des données peu prendre une éternité + ou - 1/4
			</div>
			<div class="alert alert-danger" role="alert" ng-show="false">
			  This is a danger alert—check it out!
			</div>


			<div>
				<!-- Start Date -->
				<label for="datepickerStartDate">Start Date:
					<div class="input-group date" data-provide="datepicker" id="datepickerStartDate">
						<input type="text" class="form-control">
						<div class="input-group-addon">
							<span class="glyphicon glyphicon-th"></span>
						</div>
					</div>
				</label>
				<!-- End Date -->
				<label for="datepickerEndDate">End Date:
					<div class="input-group date" data-provide="datepicker" id="datepickerEndDate">
						<input type="text" class="form-control">
						<div class="input-group-addon">
							<span class="glyphicon glyphicon-th"></span>
						</div>
					</div>
				</label>

				<button type="button" class="btn btn-primary" ng-click="updateGraphBt()">OK</button>
			</div>

			<div class="chart-container" style="position: relative;">
				<canvas id="canvasLightEnergy" style="background: white;"></canvas>
				<canvas id="canvasBoxTempHumi" style="background: white;"></canvas>
			</div>
		</div>

	</div>

    <!--Script references. -->
    <!--Reference the library. -->
    <script src="Scripts/jquery-3.3.1.min.js"></script>
    <!--Reference the SignalR library. -->
    <script src="Scripts/jquery.signalR-2.4.0.min.js"></script>

    <script src="Scripts/Chart.bundle.min.js"></script>
    <script src="Scripts/jquery.cookie-1.4.1.min.js"></script>
    <script src="Scripts/angular.min.js"></script>

    <!--Reference the autogenerated SignalR hub script. -->
    <script src="signalr/hubs"></script>
    <!--Add script to update the page and send messages.-->
	<script src="Scripts/bootstrap-datepicker.min.js"></script>

    <script type="text/javascript">
		 var mainApp = angular.module("mainApp", []);

		 // Initialize controls
		 $('.datepicker').datepicker();

		 let dpStartDate = $('#datepickerStartDate');
		  dpStartDate.on('changeDate', function(ev) {
				console.log("sd", ev.date);
				dtStartDate = ev.date;
			});

		 let dpEndDate = $('#datepickerEndDate')
			.on('changeDate', function(ev) {
				console.log("ed", ev.date);
				dtEndDate = ev.date;
			});

		 // End Date
		 let dtStartDate = new Date();
		 dtStartDate.setDate(dtStartDate.getDate());

		 // End Date
		 let dtEndDate = new Date();
		 dtEndDate.setDate(dtEndDate.getDate());

		 dpStartDate.datepicker("update", dtStartDate);
		 dpEndDate.datepicker("update", dtEndDate);

		 // Init graph.
         mainApp.controller('mainController', function($scope) {
            $scope.isAuthenticated = false;

			// Canvas light/energy
			var ctx = document.getElementById('canvasLightEnergy').getContext('2d');
			window.myBar = new Chart.Line(ctx, {
					type: 'line',
					data: [],
					options: {
						scales: {
							yAxes: [
							{
								id: "y-axis-0",
								name: 'y-axis-0',
								type: 'linear',
								position: 'left',
								scalePositionLeft: true
							},
							{
								name: 'y-axis-1',
								id: "y-axis-1",
								type: 'linear',
								position: 'right',
								scalePositionLeft: false,
							},
							{
								name: 'y-axis-2',
								id: "y-axis-2",
								type: 'linear',
								position: 'right',
								scalePositionLeft: false,
								ticks: {
									beginAtZero: true,
									min: -1,
									stepValue: 1,
									max: 3
								}
							}
							]
						},
						hoverMode: 'index',
						responsive: true,
						aspectRatio: 3,
						legend: {
							position: 'top',
						},
						title: {
							display: true,
							text: 'Energy'
						}
					}
				});

							// Canvas light/energy
			var ctx = document.getElementById('canvasBoxTempHumi').getContext('2d');
			window.myBarLightEnergy = new Chart.Line(ctx, {
					type: 'line',
					data: [],
					options: {
						scales: {
							yAxes: [
							{
								id: "y-axis-0",
								name: 'y-axis-0',
								type: 'linear',
								position: 'left',
								scalePositionLeft: true
							},
							{
								name: 'y-axis-1',
								id: "y-axis-1",
								type: 'linear',
								position: 'right',
								scalePositionLeft: false,
							},
							{
								name: 'y-axis-2',
								id: "y-axis-2",
								type: 'linear',
								position: 'right',
								scalePositionLeft: false,
							}
							]
						},
						hoverMode: 'index',
						responsive: true,
						aspectRatio: 3,
						legend: {
							position: 'top',
						},
						title: {
							display: true,
							text: 'Environmental data'
						}
					}
				});

			$(function () {
			//Set the hubs URL for the connection
				$.connection.hub.url = "signalr";


				// Declare a proxy to reference the hub.
				var mainHub = $.connection.mainHub;

				// Create a function that the hub can call to broadcast messages.
				//mainHub.client.addMessage = function (name, message) {

				//};

				 $scope.updateGraphBt = function() {
					$scope.updateGraph();
				 };

				$scope.updateGraph = function()
				{
					new Promise((resolve, reject) => {
						mainHub.server.getStationData(dtStartDate, dtEndDate)
							.done(data => resolve(data))
							.fail(reject);
					}).then(data =>
					{
						console.log("data", data);

						let curryear_labels = data.Datas.map(dd => dd.Xvalue);

						let values_light = data.Datas.map(dd => dd.lightsensorRAW);
						let values_batteryV = data.Datas.map(dd => dd.batteryV);
						let values_powermodes = data.Datas.map(dd => dd.powermode);

						var barChartData = {
							labels: curryear_labels ,
							datasets: [{
								label: 'Light',
								// backgroundColor: 'red',
								yAxisID: 'y-axis-0',
								borderColor: '#E8AC41',
								borderWidth: 2,
								data: values_light
							}, {
								label: 'Battery voltage',
								// backgroundColor: 'lightblue',
								yAxisID: 'y-axis-1',
								borderColor: 'blue',
								borderWidth: 2,
								data: values_batteryV
							}, {
								label: 'Power mode',
								// backgroundColor: 'lightblue',
								yAxisID: 'y-axis-2',
								borderColor: 'green',
								borderWidth: 2,
								data: values_powermodes
							}]

						};

						//canvasBoxTempHumi
						window.myBar.data = barChartData;
						window.myBar.update();

						/* ======
						  Light Energy data
						   ======*/
						let values_boxtempCs = data.Datas.map(dd => dd.boxtempC);
						let values_boxhumidityPERCs = data.Datas.map(dd => dd.boxhumidityPERC);

						var barChartDataLightEnergy = {
							labels: curryear_labels ,
							datasets: [{
								label: 'Light',
								// backgroundColor: 'red',
								yAxisID: 'y-axis-0',
								borderColor: '#E8AC41',
								borderWidth: 2,
								data: values_light
							}, {
								label: 'Temperature (C)',
								// backgroundColor: 'lightblue',
								yAxisID: 'y-axis-1',
								borderColor: 'red',
								borderWidth: 2,
								data: values_boxtempCs
							}, {
								label: 'Humidity (%)',
								// backgroundColor: 'lightblue',
								yAxisID: 'y-axis-2',
								borderColor: 'purple',
								borderWidth: 2,
								data: values_boxhumidityPERCs
							}]

						};

						window.myBarLightEnergy.data = barChartDataLightEnergy;
						window.myBarLightEnergy.update();
					});
				};

				// Start the connection.
				$.connection.hub.start().done(function () {
					$scope.updateGraph();
				});
			});
        });
    </script>
</body>
</html>